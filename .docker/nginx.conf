# =============================================================================
# Nginx Configuration â€” QR Generator SPA
# Serves static assets from Vite build with security headers, gzip
# compression, SPA routing, and a /health endpoint.
# =============================================================================

# Run as non-root (user created in Dockerfile)
# pid directive moved to a writable location for read-only filesystem
pid /var/run/nginx.pid;

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # --- Performance ---
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;

    # Suppress Nginx version in headers and error pages
    server_tokens off;

    # --- Gzip Compression (FR-017) ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml
        font/woff2;

    # --- Logging ---
    # Log to stdout/stderr for container best practices
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log warn;

    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;
        index index.html;

        # --- Security Headers (FR-011) ---
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self';" always;

        # --- Health Check Endpoint (FR-012) ---
        location = /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 'OK';
        }

        # --- Cache Control for Hashed Assets ---
        # Vite produces hashed filenames (e.g., index-DFep3xME.js)
        # These are safe to cache aggressively since the hash changes on content change
        location /assets/ {
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable" always;

            # Re-add security headers (add_header in nested block overrides parent)
            add_header X-Frame-Options "DENY" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self';" always;
        }

        # --- SPA Routing (FR-017) ---
        # For any route that doesn't match a file, serve index.html
        # so client-side routing (React Router) handles it
        location / {
            try_files $uri $uri/ /index.html;

            # index.html must NOT be cached (ensures users get latest deployment)
            location = /index.html {
                add_header Cache-Control "no-cache, no-store, must-revalidate" always;
                add_header Pragma "no-cache" always;
                add_header Expires "0" always;

                # Re-add security headers
                add_header X-Frame-Options "DENY" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header Referrer-Policy "strict-origin-when-cross-origin" always;
                add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self';" always;
            }
        }
    }
}
